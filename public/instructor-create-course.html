<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Course - LearNova Instructor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="navbar.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <style>
        .instructor-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .instructor-card {
            border-left: 4px solid #667eea;
        }
        .form-wizard {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3rem;
            position: relative;
        }
        .form-wizard::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e1e5e9;
            z-index: 1;
        }
        .wizard-step {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            position: relative;
            z-index: 2;
            cursor: pointer;
            transition: all 0.3s;
        }
        .wizard-step.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        .wizard-step.completed {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
        }
        .form-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-group-full {
            grid-column: 1 / -1;
        }
        .preview-section {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
        }
        .module-item, .lesson-item {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .btn-add {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e1e5e9;
            border-radius: 5px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }
        .exam-section {
            border-left: 3px solid #667eea;
        }
        .question-item {
            border-left: 2px solid #28a745;
        }
        .options-container {
            margin: 1rem 0;
        }
        .btn-add, .btn-remove {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-add:hover {
            background: #218838;
        }
        .btn-remove:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <!-- Modern navbar will be inserted here by navbar.js -->

    <main class="main-content">
        <div class="container">
            <div class="instructor-card">
                <h1 style="color: #667eea; margin-bottom: 1rem;">Create New Course</h1>
                <p style="color: #666; margin-bottom: 2rem;">Build engaging courses for your students step by step</p>
                
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
                </div>
                
                <!-- Form Wizard -->
                <div class="form-wizard">
                    <div class="wizard-step active" data-step="1">1</div>
                    <div class="wizard-step" data-step="2">2</div>
                    <div class="wizard-step" data-step="3">3</div>
                    <div class="wizard-step" data-step="4">4</div>
                    <div class="wizard-step" data-step="5">5</div>
                </div>

                <form id="courseForm" enctype="multipart/form-data" novalidate>
                    <!-- Step 1: Basic Information -->
                    <div class="step-content active" data-step="1">
                        <div class="form-section">
                            <h2 style="color: #333; margin-bottom: 1.5rem;">üìã Basic Course Information</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="courseName">Course Name *</label>
                                    <input type="text" id="courseName" name="courseName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="category">Category *</label>
                                    <select id="category" name="category" class="form-control" required>
                                        <option value="">Select Category</option>
                                        <option value="Programming">Programming</option>
                                        <option value="Web Development">Web Development</option>
                                        <option value="Data Science">Data Science</option>
                                        <option value="Design">Design</option>
                                        <option value="Business">Business</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Photography">Photography</option>
                                        <option value="Music">Music</option>
                                        <option value="Language">Language</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="level">Difficulty Level *</label>
                                    <select id="level" name="level" class="form-control" required>
                                        <option value="">Select Level</option>
                                        <option value="Beginner">Beginner</option>
                                        <option value="Intermediate">Intermediate</option>
                                        <option value="Advanced">Advanced</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="language">Language</label>
                                    <select id="language" name="language" class="form-control">
                                        <option value="English">English</option>
                                        <option value="Spanish">Spanish</option>
                                        <option value="French">French</option>
                                        <option value="German">German</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group form-group-full">
                                <label for="shortDescription">Short Description *</label>
                                <textarea id="shortDescription" name="shortDescription" class="form-control" rows="2" maxlength="150" placeholder="Brief course description (max 150 characters)" required></textarea>
                                <small class="text-muted"><span id="shortDescCount">0</span>/150 characters</small>
                            </div>

                            <div class="form-group form-group-full">
                                <label for="description">Detailed Description *</label>
                                <textarea id="description" name="description" class="form-control" rows="5" placeholder="Provide a comprehensive description of your course" required></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Course Details -->
                    <div class="step-content" data-step="2">
                        <div class="form-section">
                            <h2 style="color: #333; margin-bottom: 1.5rem;">‚öôÔ∏è Course Configuration</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="duration">Duration (weeks) *</label>
                                    <input type="number" id="duration" name="duration" class="form-control" min="1" max="52" required>
                                </div>
                                <div class="form-group">
                                    <label for="estimatedHours">Estimated Hours *</label>
                                    <input type="number" id="estimatedHours" name="estimatedHours" class="form-control" min="1" max="500" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="price">Price ($)</label>
                                    <input type="number" id="price" name="price" class="form-control" min="0" step="0.01" placeholder="0 for free course">
                                </div>
                                <div class="form-group">
                                    <label for="courseImage">Course Image</label>
                                    <input type="file" id="courseImage" name="courseImage" class="form-control" accept="image/*">
                                </div>
                            </div>

                            <div class="form-group form-group-full">
                                <label for="prerequisites">Prerequisites (one per line)</label>
                                <textarea id="prerequisites" name="prerequisites" class="form-control" rows="3" placeholder="Basic programming knowledge&#10;Familiarity with HTML/CSS&#10;Computer with internet access"></textarea>
                            </div>

                            <div class="form-group form-group-full">
                                <label for="learningOutcomes">Learning Outcomes (one per line) *</label>
                                <textarea id="learningOutcomes" name="learningOutcomes" class="form-control" rows="4" placeholder="Build modern web applications&#10;Understand advanced JavaScript concepts&#10;Deploy applications to production" required></textarea>
                            </div>

                            <div class="form-group form-group-full">
                                <label for="targetAudience">Target Audience (one per line)</label>
                                <textarea id="targetAudience" name="targetAudience" class="form-control" rows="3" placeholder="Web developers looking to advance their skills&#10;Students pursuing computer science&#10;Professionals seeking career change"></textarea>
                            </div>

                            <div class="form-group form-group-full">
                                <label for="tags">Course Tags (comma-separated)</label>
                                <input type="text" id="tags" name="tags" class="form-control" placeholder="javascript, react, web development, frontend">
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Modules -->
                    <div class="step-content" data-step="3">
                        <div class="form-section">
                            <h2 style="color: #333; margin-bottom: 1.5rem;">üìö Course Modules</h2>
                            <p style="color: #666; margin-bottom: 2rem;">Organize your course content into modules and lessons</p>
                            
                            <div id="modulesContainer">
                                <!-- Modules will be added here dynamically -->
                            </div>
                            
                            <button type="button" class="btn-add" onclick="addModule()">+ Add Module</button>
                            
                            <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #e1e5e9;">
                                <h3 style="color: #333; margin-bottom: 1.5rem;">üéì Final Course Examination</h3>
                                <p style="color: #666; margin-bottom: 1rem;">Create a comprehensive final exam that students must pass to receive certification.</p>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="hasFinalExam" name="hasFinalExam" onchange="toggleFinalExam()" style="margin-right: 0.5rem;">
                                        Enable Final Course Exam (Required for Certification)
                                    </label>
                                </div>
                                
                                <div id="finalExamSection" style="display: none; background: #f8f9ff; padding: 2rem; border-radius: 8px; border: 2px solid #667eea;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Final Exam Title</label>
                                            <input type="text" name="finalExam[title]" class="form-control" value="Final Course Examination">
                                        </div>
                                        <div class="form-group">
                                            <label>Time Limit (minutes)</label>
                                            <input type="number" name="finalExam[timeLimit]" class="form-control" value="60" min="30" max="300">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Passing Score (%) *</label>
                                            <input type="number" name="finalExam[passingScore]" class="form-control" value="70" min="60" max="100">
                                            <small class="text-muted">Students need this score to get certified</small>
                                        </div>
                                        <div class="form-group">
                                            <label>Max Attempts</label>
                                            <input type="number" name="finalExam[maxAttempts]" class="form-control" value="3" min="1" max="5">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Exam Instructions</label>
                                        <textarea name="finalExam[description]" class="form-control" rows="3" 
                                                  placeholder="Instructions for the final exam...">This is the final examination for the course. You must score 70% or above to receive your certificate. Please read each question carefully.</textarea>
                                    </div>
                                    
                                    <div class="questions-container" id="finalExamQuestionsContainer">
                                        <h5>Final Exam Questions</h5>
                                    </div>
                                    
                                    <button type="button" class="btn-add" onclick="addFinalExamQuestion()">+ Add Question</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Preview Video & Resources -->
                    <div class="step-content" data-step="4">
                        <div class="form-section">
                            <h2 style="color: #333; margin-bottom: 1.5rem;">üé• Media & Resources</h2>
                            
                            <div class="form-group">
                                <label for="previewVideo">Preview Video URL</label>
                                <input type="url" id="previewVideo" name="previewVideo" class="form-control" placeholder="https://youtube.com/watch?v=...">
                                <small class="text-muted">Add a preview video to showcase your course</small>
                            </div>

                            <div class="form-group">
                                <label for="promotionalVideo">Promotional Video URL</label>
                                <input type="url" id="promotionalVideo" name="promotionalVideo" class="form-control" placeholder="https://youtube.com/watch?v=...">
                            </div>

                            <div class="form-group">
                                <label for="resources">Additional Resources (one per line)</label>
                                <textarea id="resources" name="resources" class="form-control" rows="4" placeholder="Course handbook PDF&#10;Source code repository&#10;Useful external links"></textarea>
                            </div>

                            <div class="preview-section">
                                <h3>üìã Course Preview</h3>
                                <div id="coursePreview">
                                    <p>Complete the previous steps to see your course preview</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Review & Publish -->
                    <div class="step-content" data-step="5">
                        <div class="form-section">
                            <h2 style="color: #333; margin-bottom: 1.5rem;">‚úÖ Review & Publish</h2>
                            
                            <div class="alert alert-info">
                                <strong>üìã Review Checklist:</strong>
                                <ul style="margin: 1rem 0;">
                                    <li>‚úì Course information is complete and accurate</li>
                                    <li>‚úì At least one module with lessons is added</li>
                                    <li>‚úì Learning outcomes are clearly defined</li>
                                    <li>‚úì Course image is uploaded (recommended)</li>
                                </ul>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="agreeTerms" required style="margin-right: 0.5rem;">
                                    I agree that this course content is original and I have the right to publish it
                                </label>
                            </div>

                            <div class="form-group">
                                <label for="publishStatus">Publication Status</label>
                                <select id="publishStatus" name="publishStatus" class="form-control">
                                    <option value="draft">Save as Draft</option>
                                    <option value="pending">Submit for Review</option>
                                </select>
                                <small class="text-muted">Drafts can be edited later. Submitted courses will be reviewed by admin.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                        <button type="button" id="prevBtn" class="btn btn-outline" onclick="changeStep(-1)" style="display: none;">Previous</button>
                        <div style="display: flex; gap: 1rem;">
                            <button type="button" id="nextBtn" class="btn btn-primary" onclick="changeStep(1)">Next</button>
                            <button type="submit" id="submitBtn" class="btn btn-success" style="display: none;">Create Course</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="alertContainer"></div>

    <script>
        let currentStep = 1;
        let moduleCount = 0;
        let lessonCount = 0;
        let questionCount = 0;
        let finalExamQuestionCount = 0;

        // Authentication check
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'instructor') {
            window.location.href = 'login.html';
        }

        if (user.instructorStatus !== 'approved') {
            window.location.href = 'instructor-pending.html';
        }

        // The instructor name is handled by navbar.js
        console.log('‚úÖ Instructor authenticated:', user.fullName || 'Instructor');

        // Form wizard navigation
        function changeStep(direction) {
            console.log('Changing step from', currentStep, 'direction:', direction);
            
            if (direction === 1 && !validateCurrentStep()) {
                console.log('Validation failed, staying on step', currentStep);
                return;
            }

            const currentStepElement = document.querySelector(`.step-content[data-step="${currentStep}"]`);
            const currentWizardStep = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            
            currentStepElement.classList.remove('active');
            currentWizardStep.classList.remove('active');
            if (direction === 1) {
                currentWizardStep.classList.add('completed');
            }

            currentStep += direction;
            console.log('New step:', currentStep);

            const newStepElement = document.querySelector(`.step-content[data-step="${currentStep}"]`);
            const newWizardStep = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            
            newStepElement.classList.add('active');
            newWizardStep.classList.add('active');

            updateNavigation();
            updateProgress();
            
            if (currentStep === 4) {
                updateCoursePreview();
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            console.log('Updating navigation for step:', currentStep);

            prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
            nextBtn.style.display = currentStep < 5 ? 'block' : 'none';
            submitBtn.style.display = currentStep === 5 ? 'block' : 'none';
            
            console.log('Submit button display:', submitBtn.style.display);
        }

        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const progress = (currentStep / 5) * 100;
            progressFill.style.width = progress + '%';
        }

        function validateCurrentStep() {
            console.log('Validating step:', currentStep);
            const currentStepElement = document.querySelector(`.step-content[data-step="${currentStep}"]`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            
            console.log('Required fields found:', requiredFields.length);
            
            for (let field of requiredFields) {
                if (!field.value || !field.value.trim()) {
                    console.log('Empty required field:', field.name, field.id);
                    field.focus();
                    showAlert(`Please fill in the required field: ${field.previousElementSibling?.textContent || field.name}`, 'error');
                    return false;
                }
            }

            if (currentStep === 3) {
                const modules = document.querySelectorAll('.module-item');
                console.log('Modules found:', modules.length);
                if (modules.length === 0) {
                    showAlert('Please add at least one module', 'error');
                    return false;
                }
            }

            if (currentStep === 5) {
                const agreeTerms = document.getElementById('agreeTerms');
                if (!agreeTerms.checked) {
                    showAlert('Please agree to the terms and conditions', 'error');
                    agreeTerms.focus();
                    return false;
                }
            }

            console.log('Step validation passed');
            return true;
        }

        // Validate all steps before submission
        function validateAllSteps() {
            console.log('üîç Validating all steps before submission');
            
            // Step 1 validation
            const requiredStep1Fields = [
                { id: 'courseName', name: 'Course Name' },
                { id: 'category', name: 'Category' },
                { id: 'level', name: 'Level' },
                { id: 'shortDescription', name: 'Short Description' },
                { id: 'description', name: 'Detailed Description' }
            ];

            for (let field of requiredStep1Fields) {
                const element = document.getElementById(field.id);
                if (!element) {
                    console.error('‚ùå Field not found:', field.id);
                    showAlert(`Required field not found: ${field.name}`, 'error');
                    return false;
                }
                if (!element.value || !element.value.trim()) {
                    console.log('‚ùå Empty required field:', field.id);
                    showAlert(`Please fill in the required field: ${field.name}`, 'error');
                    // Go to step 1 to show the field
                    currentStep = 1;
                    updateStepDisplay();
                    element.focus();
                    return false;
                }
            }

            // Step 2 validation
            const requiredStep2Fields = [
                { id: 'duration', name: 'Duration (weeks)' },
                { id: 'estimatedHours', name: 'Estimated Hours' }
            ];

            for (let field of requiredStep2Fields) {
                const element = document.getElementById(field.id);
                if (!element) {
                    console.error('‚ùå Field not found:', field.id);
                    showAlert(`Required field not found: ${field.name}`, 'error');
                    return false;
                }
                if (!element.value || !element.value.trim()) {
                    console.log('‚ùå Empty required field:', field.id);
                    showAlert(`Please fill in the required field: ${field.name}`, 'error');
                    // Go to step 2 to show the field
                    currentStep = 2;
                    updateStepDisplay();
                    element.focus();
                    return false;
                }
                
                // Validate numeric values
                const numValue = parseInt(element.value);
                if (isNaN(numValue) || numValue < 1) {
                    console.log('‚ùå Invalid numeric value:', field.id, element.value);
                    showAlert(`Please enter a valid positive number for: ${field.name}`, 'error');
                    currentStep = 2;
                    updateStepDisplay();
                    element.focus();
                    return false;
                }
            }

            // Step 3 validation (modules)
            const modules = document.querySelectorAll('.module-item');
            console.log('üìã Modules found:', modules.length);
            if (modules.length === 0) {
                console.log('‚ùå No modules found');
                showAlert('Please add at least one module with lessons', 'error');
                currentStep = 3;
                updateStepDisplay();
                return false;
            }

            // Step 5 validation (terms agreement)
            const agreeTerms = document.getElementById('agreeTerms');
            if (!agreeTerms || !agreeTerms.checked) {
                console.log('‚ùå Terms not agreed');
                showAlert('Please agree to the terms and conditions', 'error');
                currentStep = 5;
                updateStepDisplay();
                if (agreeTerms) agreeTerms.focus();
                return false;
            }

            console.log('‚úÖ All validation passed');
            return true;
        }

        function updateStepDisplay() {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.remove('active');
            });
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active');
            });

            // Show current step
            document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');

            updateNavigation();
            updateProgress();
        }

        function addModule() {
            moduleCount++;
            const moduleId = `module_${moduleCount}`;
            
            const moduleHtml = `
                <div class="module-item" data-module-id="${moduleId}">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                        <h4>Module ${moduleCount}</h4>
                        <button type="button" class="btn-remove" onclick="removeModule('${moduleId}')">Remove</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Module Title *</label>
                            <input type="text" name="modules[${moduleCount-1}][title]" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Estimated Duration (minutes)</label>
                            <input type="number" name="modules[${moduleCount-1}][estimatedDuration]" class="form-control" value="60">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Module Description</label>
                        <textarea name="modules[${moduleCount-1}][description]" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="lessons-container" data-module="${moduleCount-1}">
                        <h5 style="margin: 1rem 0;">Lessons</h5>
                    </div>
                    
                    <button type="button" class="btn-add" onclick="addLesson('${moduleCount-1}')">+ Add Lesson</button>
                </div>
            `;
            
            document.getElementById('modulesContainer').insertAdjacentHTML('beforeend', moduleHtml);
        }

        function removeModule(moduleId) {
            const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
            moduleElement.remove();
        }

        function addLesson(moduleIndex) {
            lessonCount++;
            const lessonId = `lesson_${lessonCount}`;
            
            const lessonHtml = `
                <div class="lesson-item" data-lesson-id="${lessonId}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h6>Lesson ${lessonCount}</h6>
                        <button type="button" class="btn-remove" onclick="removeLesson('${lessonId}')">Remove</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Lesson Title *</label>
                            <input type="text" name="modules[${moduleIndex}][lessons][${lessonCount-1}][title]" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select name="modules[${moduleIndex}][lessons][${lessonCount-1}][type]" class="form-control">
                                <option value="video">Video</option>
                                <option value="text">Text</option>
                                <option value="document">Document</option>
                                <option value="interactive">Interactive</option>
                                <option value="image">Image</option>
                                <option value="link">External Link</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" name="modules[${moduleIndex}][lessons][${lessonCount-1}][duration]" class="form-control" value="10">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="modules[${moduleIndex}][lessons][${lessonCount-1}][isPreview]" style="margin-right: 0.5rem;">
                                Preview Lesson
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Content URL</label>
                        <input type="url" name="modules[${moduleIndex}][lessons][${lessonCount-1}][content]" class="form-control" placeholder="https://www.youtube.com/watch?v=... or https://youtu.be/...">
                        <small class="text-muted">
                            <strong>Video:</strong> YouTube, Vimeo links | 
                            <strong>Document:</strong> PDF, Google Drive links | 
                            <strong>Interactive:</strong> External websites
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Lesson Description</label>
                        <textarea name="modules[${moduleIndex}][lessons][${lessonCount-1}][description]" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="modules[${moduleIndex}][lessons][${lessonCount-1}][hasExam]" 
                                   onchange="toggleExamSection(this, '${moduleIndex}', '${lessonCount-1}')" style="margin-right: 0.5rem;">
                            Add Exam for this Lesson
                        </label>
                    </div>
                    
                    <div id="examSection_${moduleIndex}_${lessonCount-1}" class="exam-section" style="display: none; background: #f8f9ff; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <h6 style="color: #667eea; margin-bottom: 1rem;">üìù Lesson Examination</h6>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Exam Title</label>
                                <input type="text" name="modules[${moduleIndex}][lessons][${lessonCount-1}][examination][title]" 
                                       class="form-control" placeholder="Lesson Quiz">
                            </div>
                            <div class="form-group">
                                <label>Time Limit (minutes)</label>
                                <input type="number" name="modules[${moduleIndex}][lessons][${lessonCount-1}][examination][timeLimit]" 
                                       class="form-control" value="30" min="5" max="180">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Passing Score (%)</label>
                                <input type="number" name="modules[${moduleIndex}][lessons][${lessonCount-1}][examination][passingScore]" 
                                       class="form-control" value="70" min="50" max="100">
                            </div>
                            <div class="form-group">
                                <label>Max Attempts</label>
                                <input type="number" name="modules[${moduleIndex}][lessons][${lessonCount-1}][examination][maxAttempts]" 
                                       class="form-control" value="3" min="1" max="10">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Exam Description</label>
                            <textarea name="modules[${moduleIndex}][lessons][${lessonCount-1}][examination][description]" 
                                      class="form-control" rows="2" placeholder="Brief description of what this exam covers"></textarea>
                        </div>
                        
                        <div class="questions-container" id="questionsContainer_${moduleIndex}_${lessonCount-1}">
                            <h6>Exam Questions</h6>
                        </div>
                        
                        <button type="button" class="btn-add" onclick="addQuestion('${moduleIndex}', '${lessonCount-1}')">+ Add Question</button>
                    </div>
                </div>
            `;
            
            const lessonsContainer = document.querySelector(`[data-module="${moduleIndex}"]`);
            lessonsContainer.insertAdjacentHTML('beforeend', lessonHtml);
        }

        function removeLesson(lessonId) {
            const lessonElement = document.querySelector(`[data-lesson-id="${lessonId}"]`);
            lessonElement.remove();
        }

        // Exam creation functions
        function toggleExamSection(checkbox, moduleIndex, lessonIndex) {
            const examSection = document.getElementById(`examSection_${moduleIndex}_${lessonIndex}`);
            if (checkbox.checked) {
                examSection.style.display = 'block';
                // Add at least one question by default
                if (examSection.querySelector('.question-item') === null) {
                    addQuestion(moduleIndex, lessonIndex);
                }
            } else {
                examSection.style.display = 'none';
                // Clear all questions
                const questionsContainer = document.getElementById(`questionsContainer_${moduleIndex}_${lessonIndex}`);
                questionsContainer.innerHTML = '<h6>Exam Questions</h6>';
            }
        }

        function addQuestion(moduleIndex, lessonIndex) {
            questionCount++;
            const questionId = `question_${questionCount}`;
            
            const questionHtml = `
                <div class="question-item" data-question-id="${questionId}" style="background: white; border: 1px solid #e1e5e9; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h6>Question ${questionCount}</h6>
                        <button type="button" class="btn-remove" onclick="removeQuestion('${questionId}')">Remove</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Question Type</label>
                        <select name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionCount-1}][type]" 
                                class="form-control" onchange="updateQuestionOptions(this, '${moduleIndex}', '${lessonIndex}', '${questionCount-1}')">
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="true-false">True/False</option>
                            <option value="short-answer">Short Answer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Question Text *</label>
                        <textarea name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionCount-1}][question]" 
                                  class="form-control" rows="2" placeholder="Enter your question here..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Points</label>
                        <input type="number" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionCount-1}][points]" 
                               class="form-control" value="1" min="1" max="10">
                    </div>
                    
                    <div class="options-container" id="optionsContainer_${moduleIndex}_${lessonIndex}_${questionCount-1}">
                        <!-- Options will be added here based on question type -->
                    </div>
                    
                    <div class="form-group">
                        <label>Explanation (Optional)</label>
                        <textarea name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionCount-1}][explanation]" 
                                  class="form-control" rows="2" placeholder="Explain why this is the correct answer..."></textarea>
                    </div>
                </div>
            `;
            
            const questionsContainer = document.getElementById(`questionsContainer_${moduleIndex}_${lessonIndex}`);
            questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
            
            // Initialize options for the question
            updateQuestionOptions(
                document.querySelector(`[name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionCount-1}][type]"]`),
                moduleIndex, lessonIndex, questionCount-1
            );
        }

        function removeQuestion(questionId) {
            const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
            questionElement.remove();
        }

        function updateQuestionOptions(selectElement, moduleIndex, lessonIndex, questionIndex) {
            const optionsContainer = document.getElementById(`optionsContainer_${moduleIndex}_${lessonIndex}_${questionIndex}`);
            const questionType = selectElement.value;
            
            let optionsHtml = '';
            
            switch (questionType) {
                case 'multiple-choice':
                    optionsHtml = `
                        <label>Answer Options (Mark the correct answer)</label>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center;">
                                    <input type="radio" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]" 
                                           value="0" style="margin-right: 0.5rem;" required>
                                    <input type="text" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][options][0]" 
                                           class="form-control" placeholder="Option A" required style="flex: 1;">
                                </label>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center;">
                                    <input type="radio" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]" 
                                           value="1" style="margin-right: 0.5rem;" required>
                                    <input type="text" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][options][1]" 
                                           class="form-control" placeholder="Option B" required style="flex: 1;">
                                </label>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center;">
                                    <input type="radio" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]" 
                                           value="2" style="margin-right: 0.5rem;" required>
                                    <input type="text" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][options][2]" 
                                           class="form-control" placeholder="Option C" required style="flex: 1;">
                                </label>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center;">
                                    <input type="radio" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]" 
                                           value="3" style="margin-right: 0.5rem;" required>
                                    <input type="text" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][options][3]" 
                                           class="form-control" placeholder="Option D" required style="flex: 1;">
                                </label>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'true-false':
                    optionsHtml = `
                        <label>Correct Answer</label>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                            <label style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                <input type="radio" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]" 
                                       value="True" style="margin-right: 0.5rem;" required>
                                True
                            </label>
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]" 
                                       value="False" style="margin-right: 0.5rem;" required>
                                False
                            </label>
                        </div>
                    `;
                    break;
                    
                case 'short-answer':
                    optionsHtml = `
                        <div class="form-group">
                            <label>Correct Answer</label>
                            <input type="text" name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]" 
                                   class="form-control" placeholder="Enter the correct answer" required>
                            <small class="text-muted">Note: Short answers will be checked for exact match (case-insensitive)</small>
                        </div>
                    `;
                    break;
            }
            
            optionsContainer.innerHTML = optionsHtml;
        }

        // Final exam functions
        function toggleFinalExam() {
            const checkbox = document.getElementById('hasFinalExam');
            const finalExamSection = document.getElementById('finalExamSection');
            
            if (checkbox.checked) {
                finalExamSection.style.display = 'block';
                // Add at least one question by default
                if (finalExamSection.querySelector('.question-item') === null) {
                    addFinalExamQuestion();
                }
            } else {
                finalExamSection.style.display = 'none';
                // Clear all questions
                const questionsContainer = document.getElementById('finalExamQuestionsContainer');
                questionsContainer.innerHTML = '<h5>Final Exam Questions</h5>';
            }
        }

        function addFinalExamQuestion() {
            finalExamQuestionCount++;
            const questionId = `finalExamQuestion_${finalExamQuestionCount}`;
            
            const questionHtml = `
                <div class="question-item" data-question-id="${questionId}" style="background: white; border: 1px solid #e1e5e9; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h6>Question ${finalExamQuestionCount}</h6>
                        <button type="button" class="btn-remove" onclick="removeFinalExamQuestion('${questionId}')">Remove</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Question Type</label>
                        <select name="finalExam[questions][${finalExamQuestionCount-1}][type]" 
                                class="form-control" onchange="updateFinalExamQuestionOptions(this, '${finalExamQuestionCount-1}')">
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="true-false">True/False</option>
                            <option value="short-answer">Short Answer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Question Text *</label>
                        <textarea name="finalExam[questions][${finalExamQuestionCount-1}][question]" 
                                  class="form-control" rows="2" placeholder="Enter your question here..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Points</label>
                        <input type="number" name="finalExam[questions][${finalExamQuestionCount-1}][points]" 
                               class="form-control" value="2" min="1" max="10">
                    </div>
                    
                    <div class="options-container" id="finalExamOptionsContainer_${finalExamQuestionCount-1}">
                        <!-- Options will be added here based on question type -->
                    </div>
                    
                    <div class="form-group">
                        <label>Explanation (Optional)</label>
                        <textarea name="finalExam[questions][${finalExamQuestionCount-1}][explanation]" 
                                  class="form-control" rows="2" placeholder="Explain why this is the correct answer..."></textarea>
                    </div>
                </div>
            `;
            
            const questionsContainer = document.getElementById('finalExamQuestionsContainer');
            questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
            
            // Initialize options for the question
            updateFinalExamQuestionOptions(
                document.querySelector(`[name="finalExam[questions][${finalExamQuestionCount-1}][type]"]`),
                finalExamQuestionCount-1
            );
        }

        function removeFinalExamQuestion(questionId) {
            const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
            questionElement.remove();
        }

        function updateFinalExamQuestionOptions(selectElement, questionIndex) {
            const optionsContainer = document.getElementById(`finalExamOptionsContainer_${questionIndex}`);
            const questionType = selectElement.value;
            
            let optionsHtml = '';
            
            switch (questionType) {
                case 'multiple-choice':
                    optionsHtml = `
                        <label>Answer Options (Mark the correct answer)</label>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center;">
                                    <input type="radio" name="finalExam[questions][${questionIndex}][correctAnswer]" 
                                           value="0" style="margin-right: 0.5rem;" required>
                                    <input type="text" name="finalExam[questions][${questionIndex}][options][0]" 
                                           class="form-control" placeholder="Option A" required style="flex: 1;">
                                </label>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center;">
                                    <input type="radio" name="finalExam[questions][${questionIndex}][correctAnswer]" 
                                           value="1" style="margin-right: 0.5rem;" required>
                                    <input type="text" name="finalExam[questions][${questionIndex}][options][1]" 
                                           class="form-control" placeholder="Option B" required style="flex: 1;">
                                </label>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center;">
                                    <input type="radio" name="finalExam[questions][${questionIndex}][correctAnswer]" 
                                           value="2" style="margin-right: 0.5rem;" required>
                                    <input type="text" name="finalExam[questions][${questionIndex}][options][2]" 
                                           class="form-control" placeholder="Option C" required style="flex: 1;">
                                </label>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center;">
                                    <input type="radio" name="finalExam[questions][${questionIndex}][correctAnswer]" 
                                           value="3" style="margin-right: 0.5rem;" required>
                                    <input type="text" name="finalExam[questions][${questionIndex}][options][3]" 
                                           class="form-control" placeholder="Option D" required style="flex: 1;">
                                </label>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'true-false':
                    optionsHtml = `
                        <label>Correct Answer</label>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                            <label style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                <input type="radio" name="finalExam[questions][${questionIndex}][correctAnswer]" 
                                       value="True" style="margin-right: 0.5rem;" required>
                                True
                            </label>
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="finalExam[questions][${questionIndex}][correctAnswer]" 
                                       value="False" style="margin-right: 0.5rem;" required>
                                False
                            </label>
                        </div>
                    `;
                    break;
                    
                case 'short-answer':
                    optionsHtml = `
                        <div class="form-group">
                            <label>Correct Answer</label>
                            <input type="text" name="finalExam[questions][${questionIndex}][correctAnswer]" 
                                   class="form-control" placeholder="Enter the correct answer" required>
                            <small class="text-muted">Note: Short answers will be checked for exact match (case-insensitive)</small>
                        </div>
                    `;
                    break;
            }
            
            optionsContainer.innerHTML = optionsHtml;
        }

        function updateCoursePreview() {
            const formData = new FormData(document.getElementById('courseForm'));
            const modules = document.querySelectorAll('.module-item').length;
            const lessons = document.querySelectorAll('.lesson-item').length;
            const hasVideo = Array.from(document.querySelectorAll('select[name*="[type]"]')).some(select => select.value === 'video');
            const hasFinalExam = formData.get('hasFinalExam') === 'on';
            
            const preview = `
                <div style="text-align: left;">
                    <h4>${formData.get('courseName') || 'Course Name'}</h4>
                    <p><strong>Category:</strong> ${formData.get('category') || 'Not specified'}</p>
                    <p><strong>Level:</strong> ${formData.get('level') || 'Not specified'}</p>
                    <p><strong>Duration:</strong> ${formData.get('duration') || 0} weeks</p>
                    <p><strong>Estimated Hours:</strong> ${formData.get('estimatedHours') || 0} hours</p>
                    <p><strong>Price:</strong> $${formData.get('price') || 0}</p>
                    <p><strong>Modules:</strong> ${modules}</p>
                    <p><strong>Lessons:</strong> ${lessons}</p>
                    ${hasVideo ? '<p><strong>‚úÖ Contains Video Lessons</strong></p>' : ''}
                    ${hasFinalExam ? '<p><strong>üéì Final Exam Enabled (Required for Certification)</strong></p>' : ''}
                    <div style="margin-top: 1rem;">
                        <strong>Description:</strong>
                        <p style="color: #666;">${formData.get('shortDescription') || 'No description provided'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('coursePreview').innerHTML = preview;
        }

        // Character counter for short description
        document.getElementById('shortDescription').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('shortDescCount').textContent = count;
            
            if (count > 150) {
                this.style.borderColor = '#dc3545';
            } else {
                this.style.borderColor = '#ced4da';
            }
        });

        // Form submission
        document.getElementById('courseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üöÄ FORM SUBMIT EVENT TRIGGERED!');
            console.log('Event details:', {
                type: e.type,
                target: e.target.id,
                preventDefault: 'called'
            });
            
            // Validate all steps before submission
            console.log('üìã Starting form validation...');
            const validationResult = validateAllSteps();
            console.log('Validation result:', validationResult);
            
            if (!validationResult) {
                console.log('‚ùå Validation failed during submission');
                showAlert('Please complete all required fields before submitting', 'error');
                return false;
            }
            console.log('‚úÖ Form validation passed');

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = isEditMode ? 'Updating Course...' : 'Creating Course...';
            submitBtn.disabled = true;
            
            console.log('üîÑ Submit button updated, starting course creation process...');

            try {
                const formData = new FormData(this);
                console.log('üìÑ Form data collected, entries:', Array.from(formData.entries()).length);
                
                // Check authentication first
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                console.log('üîê Authentication check:', {
                    hasToken: !!token,
                    userRole: user.role,
                    userId: user.id || user._id
                });
                
                if (!token) {
                    console.log('‚ùå No authentication token found');
                    showAlert('Authentication required. Please login again.', 'error');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return false;
                }
                
                if (user.role !== 'instructor') {
                    console.log('‚ùå Invalid user role:', user.role);
                    showAlert('Access denied. Instructor role required.', 'error');
                    return false;
                }
                
                // Process form data
                const courseData = {
                    name: formData.get('courseName'),
                    category: formData.get('category'),
                    level: formData.get('level'),
                    language: formData.get('language') || 'English',
                    shortDescription: formData.get('shortDescription'),
                    description: formData.get('description'),
                    duration: parseInt(formData.get('duration')),
                    estimatedHours: parseInt(formData.get('estimatedHours')),
                    price: parseFloat(formData.get('price')) || 0,
                    previewVideo: formData.get('previewVideo') || '',
                    promotionalVideo: formData.get('promotionalVideo') || '',
                    prerequisites: (formData.get('prerequisites') || '').split('\n').filter(p => p.trim()),
                    learningOutcomes: (formData.get('learningOutcomes') || '').split('\n').filter(o => o.trim()),
                    targetAudience: (formData.get('targetAudience') || '').split('\n').filter(a => a.trim()),
                    resources: (formData.get('resources') || '').split('\n').filter(r => r.trim()),
                    tags: (formData.get('tags') || '').split(',').map(t => t.trim()).filter(t => t),
                    status: formData.get('publishStatus') || 'draft',
                    modules: [],
                    finalExam: null
                };
                
                console.log('Course data prepared:', courseData);

                // Process final exam if enabled
                const hasFinalExam = formData.get('hasFinalExam') === 'on';
                if (hasFinalExam) {
                    courseData.finalExam = {
                        isEnabled: true,
                        title: formData.get('finalExam[title]') || 'Final Course Examination',
                        description: formData.get('finalExam[description]') || '',
                        timeLimit: parseInt(formData.get('finalExam[timeLimit]')) || 60,
                        passingScore: parseInt(formData.get('finalExam[passingScore]')) || 70,
                        maxAttempts: parseInt(formData.get('finalExam[maxAttempts]')) || 3,
                        questions: []
                    };

                    // Process final exam questions
                    const finalExamQuestions = document.querySelectorAll('#finalExamQuestionsContainer .question-item');
                    console.log('Found final exam questions:', finalExamQuestions.length);
                    
                    finalExamQuestions.forEach((questionEl, questionIndex) => {
                        const questionType = formData.get(`finalExam[questions][${questionIndex}][type]`);
                        const questionText = formData.get(`finalExam[questions][${questionIndex}][question]`);
                        
                        console.log(`Question ${questionIndex}:`, {
                            type: questionType,
                            text: questionText,
                            element: questionEl
                        });
                        
                        // Skip empty questions
                        if (!questionText || !questionText.trim()) {
                            console.log(`Skipping empty question ${questionIndex}`);
                            return;
                        }
                        
                        const questionData = {
                            type: questionType,
                            question: questionText.trim(),
                            points: parseInt(formData.get(`finalExam[questions][${questionIndex}][points]`)) || 2,
                            explanation: formData.get(`finalExam[questions][${questionIndex}][explanation]`) || ''
                        };

                        // Handle different question types
                        if (questionType === 'multiple-choice') {
                            questionData.options = [
                                formData.get(`finalExam[questions][${questionIndex}][options][0]`),
                                formData.get(`finalExam[questions][${questionIndex}][options][1]`),
                                formData.get(`finalExam[questions][${questionIndex}][options][2]`),
                                formData.get(`finalExam[questions][${questionIndex}][options][3]`)
                            ].filter(option => option && option.trim());
                            
                            const correctIndex = formData.get(`finalExam[questions][${questionIndex}][correctAnswer]`);
                            console.log(`Multiple choice question ${questionIndex}:`, {
                                options: questionData.options,
                                correctIndex: correctIndex,
                                correctAnswer: questionData.options[parseInt(correctIndex)]
                            });
                            
                            if (correctIndex !== null && correctIndex !== '' && questionData.options[parseInt(correctIndex)]) {
                                questionData.correctAnswer = questionData.options[parseInt(correctIndex)];
                            } else {
                                // Skip questions without valid correct answer
                                console.log(`Skipping question ${questionIndex} - no valid correct answer`);
                                return;
                            }
                        } else {
                            const correctAnswer = formData.get(`finalExam[questions][${questionIndex}][correctAnswer]`);
                            console.log(`${questionType} question ${questionIndex}:`, {
                                correctAnswer: correctAnswer
                            });
                            
                            if (!correctAnswer || !correctAnswer.trim()) {
                                // Skip questions without correct answer
                                console.log(`Skipping question ${questionIndex} - empty correct answer`);
                                return;
                            }
                            questionData.correctAnswer = correctAnswer.trim();
                        }

                        // Only add valid questions with proper correct answers
                        if (questionData.correctAnswer) {
                            console.log(`Adding valid question ${questionIndex}:`, questionData);
                            courseData.finalExam.questions.push(questionData);
                        }
                    });

                    // Validate final exam has questions if enabled
                    if (courseData.finalExam.questions.length === 0) {
                        console.log('No valid final exam questions found');
                        alert('Final exam must have at least one valid question with correct answer.');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        return;
                    }
                    
                    console.log('Final exam data:', courseData.finalExam);
                }

                // Process modules
                const moduleElements = document.querySelectorAll('.module-item');
                console.log('Processing modules:', moduleElements.length);
                
                if (moduleElements.length === 0) {
                    console.log('No modules found, adding default module');
                    // Add default module if none exists
                    courseData.modules = [{
                        title: 'Introduction Module',
                        description: 'Basic introduction to the course',
                        estimatedDuration: 60,
                        order: 1,
                        lessons: [{
                            title: 'Welcome Lesson',
                            description: 'Welcome to the course',
                            type: 'video',
                            content: courseData.previewVideo || 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                            duration: 10,
                            order: 1,
                            isPreview: true,
                            examination: {
                                isEnabled: false,
                                title: '',
                                description: '',
                                timeLimit: 30,
                                passingScore: 70,
                                maxAttempts: 3,
                                questions: []
                            },
                            resources: []
                        }],
                        materials: [],
                        assignments: []
                    }];
                } else {
                    moduleElements.forEach((moduleEl, index) => {
                    const moduleData = {
                        title: formData.get(`modules[${index}][title]`),
                        description: formData.get(`modules[${index}][description]`) || '',
                        estimatedDuration: parseInt(formData.get(`modules[${index}][estimatedDuration]`)) || 60,
                        order: index + 1,
                        lessons: []
                    };

                    // Process lessons for this module
                    const lessonElements = moduleEl.querySelectorAll('.lesson-item');
                    lessonElements.forEach((lessonEl, lessonIndex) => {
                        const hasExam = formData.get(`modules[${index}][lessons][${lessonIndex}][hasExam]`) === 'on';
                        
                        const lessonData = {
                            title: formData.get(`modules[${index}][lessons][${lessonIndex}][title]`),
                            description: formData.get(`modules[${index}][lessons][${lessonIndex}][description]`) || '',
                            type: formData.get(`modules[${index}][lessons][${lessonIndex}][type]`),
                            content: formData.get(`modules[${index}][lessons][${lessonIndex}][content]`) || '',
                            duration: parseInt(formData.get(`modules[${index}][lessons][${lessonIndex}][duration]`)) || 10,
                            order: lessonIndex + 1,
                            isPreview: formData.get(`modules[${index}][lessons][${lessonIndex}][isPreview]`) === 'on',
                            examination: {
                                isEnabled: hasExam,
                                title: hasExam ? formData.get(`modules[${index}][lessons][${lessonIndex}][examination][title]`) || 'Lesson Quiz' : '',
                                description: hasExam ? formData.get(`modules[${index}][lessons][${lessonIndex}][examination][description]`) || '' : '',
                                timeLimit: hasExam ? parseInt(formData.get(`modules[${index}][lessons][${lessonIndex}][examination][timeLimit]`)) || 30 : 30,
                                passingScore: hasExam ? parseInt(formData.get(`modules[${index}][lessons][${lessonIndex}][examination][passingScore]`)) || 70 : 70,
                                maxAttempts: hasExam ? parseInt(formData.get(`modules[${index}][lessons][${lessonIndex}][examination][maxAttempts]`)) || 3 : 3,
                                questions: []
                            }
                        };

                        // Process exam questions if exam is enabled
                        if (hasExam) {
                            const questionElements = lessonEl.querySelectorAll('.question-item');
                            questionElements.forEach((questionEl, questionIndex) => {
                                const questionType = formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][type]`);
                                const questionText = formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][question]`);
                                
                                // Skip empty questions
                                if (!questionText || !questionText.trim()) {
                                    return;
                                }
                                
                                const questionData = {
                                    type: questionType,
                                    question: questionText.trim(),
                                    points: parseInt(formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][points]`)) || 1,
                                    explanation: formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][explanation]`) || ''
                                };

                                // Handle different question types
                                if (questionType === 'multiple-choice') {
                                    questionData.options = [
                                        formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][options][0]`),
                                        formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][options][1]`),
                                        formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][options][2]`),
                                        formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][options][3]`)
                                    ].filter(option => option && option.trim());
                                    
                                    const correctIndex = formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]`);
                                    if (correctIndex !== null && correctIndex !== '' && questionData.options[parseInt(correctIndex)]) {
                                        questionData.correctAnswer = questionData.options[parseInt(correctIndex)];
                                    } else {
                                        // Skip questions without valid correct answer
                                        return;
                                    }
                                } else {
                                    const correctAnswer = formData.get(`modules[${index}][lessons][${lessonIndex}][examination][questions][${questionIndex}][correctAnswer]`);
                                    if (!correctAnswer || !correctAnswer.trim()) {
                                        // Skip questions without correct answer
                                        return;
                                    }
                                    questionData.correctAnswer = correctAnswer.trim();
                                }

                                // Only add valid questions with proper correct answers
                                if (questionData.correctAnswer) {
                                    lessonData.examination.questions.push(questionData);
                                }
                            });
                        }

                        moduleData.lessons.push(lessonData);
                    });

                    courseData.modules.push(moduleData);
                });
                }

                const apiUrl = isEditMode ? `/api/courses/${editingCourseId}` : '/api/courses';
                const method = isEditMode ? 'PUT' : 'POST';
                
                // Final validation
                if (!courseData.name || !courseData.category || !courseData.level) {
                    console.error('Missing required fields:', {
                        name: courseData.name,
                        category: courseData.category,
                        level: courseData.level
                    });
                    showAlert('Missing required course information', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                if (!courseData.modules || courseData.modules.length === 0) {
                    console.error('No modules found');
                    showAlert('Course must have at least one module', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                console.log('Making API request to:', apiUrl);
                console.log('Method:', method);
                console.log('Authorization token present:', !!token);
                console.log('Final course data:', JSON.stringify(courseData, null, 2));

                const response = await fetch(apiUrl, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(courseData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Success result:', result);
                    showAlert(isEditMode ? 'Course updated successfully!' : 'Course created successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = 'instructor-courses.html';
                    }, 2000);
                } else {
                    const error = await response.json();
                    console.error('API Error:', error);
                    showAlert(error.message || (isEditMode ? 'Failed to update course' : 'Failed to create course'), 'error');
                }
            } catch (error) {
                console.error(isEditMode ? 'Course update error:' : 'Course creation error:', error);
                showAlert(isEditMode ? 'An error occurred while updating the course' : 'An error occurred while creating the course', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Course creation form loaded');
            
            // Check authentication
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('‚ùå No authentication token found');
                window.location.href = 'login.html';
                return;
            }
            
            // Add submit button click handler for debugging
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    console.log('üñ±Ô∏è SUBMIT BUTTON CLICKED!');
                    console.log('Button details:', {
                        type: submitBtn.type,
                        disabled: submitBtn.disabled,
                        form: submitBtn.form?.id
                    });
                    console.log('Click event:', e);
                });
            }
            
            // Initialize first step
            currentStep = 1;
            updateNavigation();
            updateProgress();
            
            // Check for edit mode
            checkEditMode();
            
            console.log('‚úÖ Form initialization complete');
        });

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            let backgroundColor, borderColor, textColor;
            switch(type) {
                case 'success':
                    backgroundColor = '#d4edda';
                    borderColor = '#c3e6cb';
                    textColor = '#155724';
                    break;
                case 'error':
                    backgroundColor = '#f8d7da';
                    borderColor = '#f5c6cb';
                    textColor = '#721c24';
                    break;
                case 'info':
                    backgroundColor = '#d1ecf1';
                    borderColor = '#bee5eb';
                    textColor = '#0c5460';
                    break;
                default:
                    backgroundColor = '#f8d7da';
                    borderColor = '#f5c6cb';
                    textColor = '#721c24';
            }
            
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                max-width: 400px;
                padding: 1rem;
                border-radius: 5px;
                background: ${backgroundColor};
                border: 1px solid ${borderColor};
                color: ${textColor};
            `;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, type === 'info' ? 2000 : 5000);
        }

        // Edit mode functionality
        let isEditMode = false;
        let editingCourseId = null;

        // Check if in edit mode
        function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('courseId');
            const mode = urlParams.get('mode');
            
            if (mode === 'edit' && courseId) {
                isEditMode = true;
                editingCourseId = courseId;
                document.title = 'Edit Course - LearNova Instructor';
                
                // Update page heading and submit button text
                const heading = document.querySelector('h1');
                if (heading) {
                    heading.textContent = 'Edit Course';
                }
                
                const subheading = document.querySelector('h1 + p');
                if (subheading) {
                    subheading.textContent = 'Update your course content and settings';
                }
                
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Course';
                }
                
                loadCourseForEdit(courseId);
                return true;
            }
            return false;
        }

        // Load course data for editing
        async function loadCourseForEdit(courseId) {
            console.log('Loading course for edit:', courseId);
            
            // Add a loading indicator
            showAlert('Loading course data...', 'info');
            
            try {
                const token = localStorage.getItem('token');
                console.log('Using token:', token ? 'Token exists' : 'No token');
                
                const response = await fetch(`/api/courses/${courseId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('API response status:', response.status);
                console.log('API response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    showAlert(`Failed to load course: ${response.status} - ${errorText}`, 'error');
                    
                    // Don't redirect immediately, wait for user to see the error
                    setTimeout(() => {
                        window.location.href = 'instructor-courses.html';
                    }, 3000);
                    return;
                }
                
                const course = await response.json();
                console.log('Course data loaded:', course);
                
                // Verify instructor owns this course
                const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                console.log('Course instructor:', course.instructor);
                console.log('Current user:', currentUser);
                
                // Check if instructor matches (handle both string ID and object cases)
                const courseInstructorId = typeof course.instructor === 'object' ? course.instructor._id : course.instructor;
                const currentUserId = currentUser.id || currentUser._id;
                
                console.log('Comparing IDs:', {
                    courseInstructorId,
                    currentUserId,
                    match: courseInstructorId === currentUserId
                });
                
                if (courseInstructorId !== currentUserId) {
                    showAlert('Access denied. You can only edit your own courses.', 'error');
                    setTimeout(() => {
                        window.location.href = 'instructor-courses.html';
                    }, 3000);
                    return;
                }
                
                // Step 1: Basic Information
                document.getElementById('courseName').value = course.name || '';
                document.getElementById('category').value = course.category || '';
                document.getElementById('level').value = course.level || '';
                document.getElementById('language').value = course.language || 'English';
                document.getElementById('shortDescription').value = course.shortDescription || '';
                document.getElementById('description').value = course.description || '';
                
                // Update character counter
                const shortDescCount = document.getElementById('shortDescCount');
                if (shortDescCount) {
                    shortDescCount.textContent = (course.shortDescription || '').length;
                }
                
                // Step 2: Course Details
                document.getElementById('duration').value = course.duration || '';
                document.getElementById('estimatedHours').value = course.estimatedHours || '';
                document.getElementById('price').value = course.price || 0;
                
                // Handle prerequisites
                if (course.prerequisites && Array.isArray(course.prerequisites)) {
                    document.getElementById('prerequisites').value = course.prerequisites.join('\n');
                }
                
                // Handle learning outcomes
                if (course.learningOutcomes && Array.isArray(course.learningOutcomes)) {
                    document.getElementById('learningOutcomes').value = course.learningOutcomes.join('\n');
                }
                
                // Handle target audience
                if (course.targetAudience && Array.isArray(course.targetAudience)) {
                    document.getElementById('targetAudience').value = course.targetAudience.join('\n');
                }
                
                // Handle tags
                if (course.tags && Array.isArray(course.tags)) {
                    document.getElementById('tags').value = course.tags.join(', ');
                }
                
                // Step 3: Modules and Final Exam
                document.getElementById('modulesContainer').innerHTML = '';
                moduleCount = 0;
                lessonCount = 0;
                questionCount = 0;
                
                if (course.modules && course.modules.length > 0) {
                    course.modules.forEach((module, moduleIndex) => {
                        addModule();
                        
                        // Wait for DOM to update
                        setTimeout(() => {
                            const moduleContainer = document.querySelector('.module-item:last-child');
                            if (!moduleContainer) {
                                console.error('Module container not found for index:', moduleIndex);
                                return;
                            }
                            
                            // Populate module data with safety checks
                            const titleInput = moduleContainer.querySelector(`input[name="modules[${moduleIndex}][title]"]`);
                            const durationInput = moduleContainer.querySelector(`input[name="modules[${moduleIndex}][estimatedDuration]"]`);
                            const descTextarea = moduleContainer.querySelector(`textarea[name="modules[${moduleIndex}][description]"]`);
                            
                            if (titleInput) titleInput.value = module.title || '';
                            if (durationInput) durationInput.value = module.estimatedDuration || 60;
                            if (descTextarea) descTextarea.value = module.description || '';
                            
                            // Clear default lesson and add module lessons
                            const lessonsContainer = moduleContainer.querySelector('.lessons-container');
                            
                            if (module.lessons && module.lessons.length > 0) {
                                module.lessons.forEach((lesson, lessonIndex) => {
                                    addLesson(moduleIndex);
                                    
                                    // Wait for lesson DOM to update
                                    setTimeout(() => {
                                        const lessonContainer = lessonsContainer.querySelector('.lesson-item:last-child');
                                        if (!lessonContainer) {
                                            console.error('Lesson container not found for module:', moduleIndex, 'lesson:', lessonIndex);
                                            return;
                                        }
                                        
                                        // Populate lesson data with safety checks
                                        const lessonTitleInput = lessonContainer.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][title]"]`);
                                        const lessonTypeSelect = lessonContainer.querySelector(`select[name="modules[${moduleIndex}][lessons][${lessonIndex}][type]"]`);
                                        const lessonDurationInput = lessonContainer.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][duration]"]`);
                                        const lessonContentInput = lessonContainer.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][content]"]`);
                                        const lessonDescTextarea = lessonContainer.querySelector(`textarea[name="modules[${moduleIndex}][lessons][${lessonIndex}][description]"]`);
                                        const previewCheckbox = lessonContainer.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][isPreview]"]`);
                                        
                                        if (lessonTitleInput) lessonTitleInput.value = lesson.title || '';
                                        if (lessonTypeSelect) lessonTypeSelect.value = lesson.type || 'video';
                                        if (lessonDurationInput) lessonDurationInput.value = lesson.duration || 10;
                                        if (lessonContentInput) lessonContentInput.value = lesson.content || '';
                                        if (lessonDescTextarea) lessonDescTextarea.value = lesson.description || '';
                                        if (previewCheckbox) previewCheckbox.checked = lesson.isPreview || false;
                                        
                                        // Handle examination data if present
                                        if (lesson.examination && lesson.examination.isEnabled) {
                                            const examCheckbox = lessonContainer.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][hasExam]"]`);
                                            if (examCheckbox) {
                                                examCheckbox.checked = true;
                                                toggleExamSection(examCheckbox, moduleIndex, lessonIndex);
                                                
                                                // Populate exam details
                                                setTimeout(() => {
                                                    const examSection = document.getElementById(`examSection_${moduleIndex}_${lessonIndex}`);
                                                    if (examSection) {
                                                        const examTitleInput = examSection.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][title]"]`);
                                                        const examTimeLimitInput = examSection.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][timeLimit]"]`);
                                                        const examPassingScoreInput = examSection.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][passingScore]"]`);
                                                        const examMaxAttemptsInput = examSection.querySelector(`input[name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][maxAttempts]"]`);
                                                        const examDescTextarea = examSection.querySelector(`textarea[name="modules[${moduleIndex}][lessons][${lessonIndex}][examination][description]"]`);
                                                        
                                                        if (examTitleInput) examTitleInput.value = lesson.examination.title || '';
                                                        if (examTimeLimitInput) examTimeLimitInput.value = lesson.examination.timeLimit || 30;
                                                        if (examPassingScoreInput) examPassingScoreInput.value = lesson.examination.passingScore || 70;
                                                        if (examMaxAttemptsInput) examMaxAttemptsInput.value = lesson.examination.maxAttempts || 3;
                                                        if (examDescTextarea) examDescTextarea.value = lesson.examination.description || '';
                                                        
                                                        // Add examination questions
                                                        if (lesson.examination.questions && lesson.examination.questions.length > 0) {
                                                            lesson.examination.questions.forEach((question, questionIndex) => {
                                                                addQuestion(moduleIndex, lessonIndex);
                                                                
                                                                setTimeout(() => {
                                                                    const questionContainer = examSection.querySelector('.question-item:last-child');
                                                                    if (questionContainer) {
                                                                        // Populate question data with safety checks
                                                                        const questionTypeSelect = questionContainer.querySelector(`select[name*="[type]"]`);
                                                                        const questionTextArea = questionContainer.querySelector(`textarea[name*="[question]"]`);
                                                                        const questionPointsInput = questionContainer.querySelector(`input[name*="[points]"]`);
                                                                        const questionExplanationTextarea = questionContainer.querySelector(`textarea[name*="[explanation]"]`);
                                                                        
                                                                        if (questionTypeSelect) questionTypeSelect.value = question.type || 'multiple-choice';
                                                                        if (questionTextArea) questionTextArea.value = question.question || '';
                                                                        if (questionPointsInput) questionPointsInput.value = question.points || 1;
                                                                        if (questionExplanationTextarea) questionExplanationTextarea.value = question.explanation || '';
                                                                        
                                                                        // Update options based on question type
                                                                        if (questionTypeSelect) {
                                                                            const currentQuestionIndex = questionCount - 1;
                                                                            updateQuestionOptions(questionTypeSelect, moduleIndex, lessonIndex, currentQuestionIndex);
                                                                            
                                                                            // Populate answer options
                                                                            setTimeout(() => {
                                                                                if (question.type === 'multiple-choice' && question.options) {
                                                                                    question.options.forEach((option, optionIndex) => {
                                                                                        const optionInput = questionContainer.querySelector(`input[name*="[options][${optionIndex}]"]`);
                                                                                        if (optionInput) {
                                                                                            optionInput.value = option;
                                                                                        }
                                                                                    });
                                                                                    
                                                                                    // Set correct answer
                                                                                    const correctIndex = question.options.indexOf(question.correctAnswer);
                                                                                    if (correctIndex >= 0) {
                                                                                        const correctRadio = questionContainer.querySelector(`input[name*="[correctAnswer]"][value="${correctIndex}"]`);
                                                                                        if (correctRadio) {
                                                                                            correctRadio.checked = true;
                                                                                        }
                                                                                    }
                                                                                } else if (question.type === 'true-false') {
                                                                                    const correctRadio = questionContainer.querySelector(`input[name*="[correctAnswer]"][value="${question.correctAnswer}"]`);
                                                                                    if (correctRadio) {
                                                                                        correctRadio.checked = true;
                                                                                    }
                                                                                } else if (question.type === 'short-answer') {
                                                                                    const answerInput = questionContainer.querySelector(`input[name*="[correctAnswer]"]`);
                                                                                    if (answerInput) {
                                                                                        answerInput.value = question.correctAnswer || '';
                                                                                    }
                                                                                }
                                                                            }, 100);
                                                                        }
                                                                    }
                                                                }, 50);
                                                            });
                                                        }
                                                    }
                                                }, 100);
                                            }
                                        }
                                    }, 50);
                                });
                            }
                        }, 50);
                    });
                }
                
                // Handle Final Exam
                if (course.finalExam && course.finalExam.isEnabled) {
                    const finalExamCheckbox = document.getElementById('hasFinalExam');
                    finalExamCheckbox.checked = true;
                    toggleFinalExam();
                    
                    // Populate final exam details
                    document.querySelector('input[name="finalExam[title]"]').value = course.finalExam.title || 'Final Course Examination';
                    document.querySelector('input[name="finalExam[timeLimit]"]').value = course.finalExam.timeLimit || 60;
                    document.querySelector('input[name="finalExam[passingScore]"]').value = course.finalExam.passingScore || 70;
                    document.querySelector('input[name="finalExam[maxAttempts]"]').value = course.finalExam.maxAttempts || 3;
                    document.querySelector('textarea[name="finalExam[description]"]').value = course.finalExam.description || '';
                    
                    // Add final exam questions
                    if (course.finalExam.questions && course.finalExam.questions.length > 0) {
                        course.finalExam.questions.forEach((question, questionIndex) => {
                            addFinalExamQuestion();
                            const questionContainer = document.getElementById('finalExamQuestionsContainer').querySelector('.question-item:last-child');
                            
                            // Populate question data
                            questionContainer.querySelector(`select[name="finalExam[questions][${finalExamQuestionCount-1}][type]"]`).value = question.type || 'multiple-choice';
                            questionContainer.querySelector(`textarea[name="finalExam[questions][${finalExamQuestionCount-1}][question]"]`).value = question.question || '';
                            questionContainer.querySelector(`input[name="finalExam[questions][${finalExamQuestionCount-1}][points]"]`).value = question.points || 2;
                            questionContainer.querySelector(`textarea[name="finalExam[questions][${finalExamQuestionCount-1}][explanation]"]`).value = question.explanation || '';
                            
                            // Update options based on question type
                            const typeSelect = questionContainer.querySelector(`select[name="finalExam[questions][${finalExamQuestionCount-1}][type]"]`);
                            updateFinalExamQuestionOptions(typeSelect, finalExamQuestionCount-1);
                            
                            // Populate answer options
                            setTimeout(() => {
                                if (question.type === 'multiple-choice' && question.options) {
                                    question.options.forEach((option, optionIndex) => {
                                        const optionInput = questionContainer.querySelector(`input[name="finalExam[questions][${finalExamQuestionCount-1}][options][${optionIndex}]"]`);
                                        if (optionInput) {
                                            optionInput.value = option;
                                        }
                                    });
                                    
                                    // Set correct answer
                                    const correctRadio = questionContainer.querySelector(`input[name="finalExam[questions][${finalExamQuestionCount-1}][correctAnswer]"][value="${question.correctAnswer}"]`);
                                    if (correctRadio) {
                                        correctRadio.checked = true;
                                    }
                                } else if (question.type === 'true-false') {
                                    const correctRadio = questionContainer.querySelector(`input[name="finalExam[questions][${finalExamQuestionCount-1}][correctAnswer]"][value="${question.correctAnswer}"]`);
                                    if (correctRadio) {
                                        correctRadio.checked = true;
                                    }
                                } else if (question.type === 'short-answer') {
                                    const answerInput = questionContainer.querySelector(`input[name="finalExam[questions][${finalExamQuestionCount-1}][correctAnswer]"]`);
                                    if (answerInput) {
                                        answerInput.value = question.correctAnswer || '';
                                    }
                                }
                            }, 100);
                        });
                    }
                }
                
                // Step 4: Media & Resources
                document.getElementById('previewVideo').value = course.previewVideo || '';
                document.getElementById('promotionalVideo').value = course.promotionalVideo || '';
                
                if (course.resources && Array.isArray(course.resources)) {
                    document.getElementById('resources').value = course.resources.join('\n');
                }
                
                // Step 5: Publication Status
                document.getElementById('publishStatus').value = course.status || 'draft';
                
                showAlert('Course loaded for editing', 'success');
                
            } catch (error) {
                console.error('Error loading course for edit:', error);
                showAlert(`Failed to load course for editing: ${error.message}`, 'error');
                
                // Don't redirect immediately, wait for user to see the error
                setTimeout(() => {
                    window.location.href = 'instructor-courses.html';
                }, 3000);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check edit mode first
            if (!checkEditMode()) {
                // Initialize with first module only if not in edit mode
                addModule();
            }
        });
    </script>

    <!-- Modern Navbar Script -->
    <script src="navbar.js"></script>
</body>
</html>

