<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - LearNova</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="navbar.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <style>
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        .course-card {
            position: relative;
            overflow: hidden;
        }
        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .achievement-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            border-radius: 20px;
            font-weight: bold;
            margin: 0.25rem;
        }
        .notification-dot {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            border: 2px solid white;
        }
        .alert {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <!-- Navbar will be inserted here by navbar.js -->

    <main class="main-content">
        <div class="container">
            <!-- Welcome Section -->
            <section style="margin-bottom: 3rem;">
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h1 style="margin-bottom: 1rem;">Welcome back, <span id="studentName">Student</span>! üéì</h1>
                    <p style="opacity: 0.9; font-size: 1.1rem;">Continue your learning journey and achieve your goals.</p>
                </div>
            </section>

            <!-- Learning Statistics -->
            <section style="margin-bottom: 3rem;">
                <h2 style="margin-bottom: 2rem; color: #333;">Your Learning Progress</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="enrolledCourses">0</div>
                        <div class="stat-label">Enrolled Courses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedCourses">0</div>
                        <div class="stat-label">Completed Courses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="certificatesEarned">0</div>
                        <div class="stat-label">Certificates Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalHours">0</div>
                        <div class="stat-label">Hours Learned</div>
                    </div>
                </div>
            </section>

            <!-- Continue Learning -->
            <section style="margin-bottom: 3rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="margin: 0; color: #333;">Continue Learning</h2>
                    <a href="my-courses.html" class="btn btn-outline">View All</a>
                </div>
                <div id="continueLearning">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>

            <!-- Achievements -->
            <section style="margin-bottom: 3rem;" id="achievementsSection" style="display: none;">
                <h2 style="margin-bottom: 2rem; color: #333;">Recent Achievements üèÜ</h2>
                <div class="card">
                    <div id="achievements">
                        <!-- Achievements will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Recommended Courses -->
            <section style="margin-bottom: 3rem;">
                <h2 style="margin-bottom: 2rem; color: #333;">My courses</h2>
                <div id="recommendedCourses">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>

            <!-- Recent Activity -->
            <section style="margin-bottom: 3rem;">
                <h2 style="margin-bottom: 2rem; color: #333;">Recent Activity</h2>
                <div class="card">
                    <div id="recentActivity">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section>
                <h2 style="margin-bottom: 2rem; color: #333;">Quick Actions</h2>
                <div class="course-grid">
                    <div class="card text-center course-card">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                        <h3 style="margin-bottom: 1rem;">Browse Courses</h3>
                        <p style="color: #666; margin-bottom: 1.5rem;">Discover new courses and expand your skills</p>
                        <a href="courses.html" class="btn btn-primary">Browse Now</a>
                    </div>
                    <div class="card text-center course-card">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                        <h3 style="margin-bottom: 1rem;">Track Progress</h3>
                        <p style="color: #666; margin-bottom: 1.5rem;">Monitor your learning progress and achievements</p>
                        <a href="progress.html" class="btn btn-primary">View Progress</a>
                    </div>
                    <div class="card text-center course-card">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üí¨</div>
                        <h3 style="margin-bottom: 1rem;">Ask Questions</h3>
                        <p style="color: #666; margin-bottom: 1.5rem;">Get help from instructors and community</p>
                        <a href="queries.html" class="btn btn-primary">Ask Question</a>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Course Details Modal -->
    <div id="courseModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #eee;">
                <h2 id="modalCourseTitle" style="margin: 0;">Course Details</h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
            </div>
            <div id="modalCourseContent">
                <!-- Course details will be loaded here -->
            </div>
        </div>
    </div>

    <footer style="background: #333; color: white; padding: 2rem 0; text-align: center; margin-top: 4rem;">
        <div class="container">
            <p>&copy; 2025 LearnHub. All rights reserved.</p>
        </div>
    </footer>

    <script>
        let currentUser = null;

        // Check authentication and student status
        function checkAuth() {
            // Check both 'user' and 'userData' for compatibility
            const user = localStorage.getItem('userData') || localStorage.getItem('user');
            if (!user) {
                window.location.href = 'login.html';
                return null;
            }
            
            currentUser = JSON.parse(user);
            
            if (currentUser.role !== 'student') {
                // Redirect to appropriate dashboard based on role
                if (currentUser.role === 'instructor') {
                    window.location.href = 'instructor-dashboard.html';
                } else if (currentUser.role === 'admin') {
                    window.location.href = 'admin-dashboard.html';
                }
                return null;
            }
            
            // Handle different name properties
            const displayName = currentUser.username || currentUser.name || currentUser.fullName;
            const fullName = currentUser.fullName || currentUser.name || currentUser.username;
            
            // Check if elements exist before setting textContent
            const userWelcomeEl = document.getElementById('userWelcome');
            const studentNameEl = document.getElementById('studentName');
            
            if (userWelcomeEl) {
                userWelcomeEl.textContent = `Welcome, ${displayName}!`;
            }
            if (studentNameEl) {
                studentNameEl.textContent = fullName;
            }
            
            return currentUser;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // Load student dashboard data
        async function loadStudentData() {
            if (!currentUser) {
                console.error('No current user found');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('No token found');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('Loading student data for:', currentUser.email);
                
                // Check server connectivity first
                const serverOnline = await checkServerConnection();
                if (!serverOnline) {
                    showAlert('üîÑ Connecting to server... Some features may be limited.', 'info');
                }
                
                // Try to refresh progress silently (completely optional)
                fetch('/api/refresh-progress', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }).then(refreshResponse => {
                    if (refreshResponse.ok) {
                        console.log('Progress refreshed successfully');
                    } else {
                        console.log('Progress refresh failed silently, status:', refreshResponse.status);
                    }
                }).catch(refreshError => {
                    console.log('Progress refresh failed silently:', refreshError.message);
                });

                // Load student progress
                const progressResponse = await fetch('/api/student-progress-details', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!progressResponse.ok) {
                    throw new Error('Failed to fetch progress data');
                }

                const progressData = await progressResponse.json();

                // Update statistics
                const enrolledCount = progressData.length;
                const completedCount = progressData.filter(course => course.isCompleted).length;
                const certificatesCount = progressData.filter(course => course.certificateIssued).length;
                const totalHours = progressData.reduce((sum, course) => {
                    const progress = typeof course.overallProgress === 'number' && !isNaN(course.overallProgress) ? course.overallProgress : 0;
                    return sum + (progress * 0.1);
                }, 0);

                animateNumber('enrolledCourses', enrolledCount);
                animateNumber('completedCourses', completedCount);
                animateNumber('certificatesEarned', certificatesCount);
                animateNumber('totalHours', Math.round(totalHours));

                // Load continue learning section
                loadContinueLearning(progressData);

                // Load achievements
                loadAchievements(progressData);

                // Load recent activity
                loadRecentActivity(progressData);

                // Load recommended courses
                loadRecommendedCourses();

            } catch (error) {
                console.error('Error loading student data:', error);
                showAlert('Unable to load dashboard data.');
            }
        }

        // Load continue learning section
        function loadContinueLearning(progressData) {
            const container = document.getElementById('continueLearning');
            
            // Filter courses for continue learning section
            const inProgressCourses = progressData.filter(course => {
                // Skip courses with missing course information (deleted courses)
                if (!course.courseName || course.courseName === 'Unknown Course' || course.courseName === 'Deleted Course') {
                    return false;
                }
                
                // Skip courses that already have certificates issued
                if (course.certificateIssued) {
                    return false;
                }
                
                const progress = course.overallProgress || 0;
                const finalExamTaken = course.finalExamTaken || false;
                const finalExamPassed = course.finalExamPassed || false;
                
                // Include courses that:
                // 1. Have progress between 0-100% (including 0% for enrolled but not started courses)
                // 2. Are at 100% but need final exam
                // 3. Are at 100% and passed final exam but don't have certificate yet
                return (progress >= 0 && progress < 100) || 
                       (progress >= 100 && !finalExamTaken) ||
                       (progress >= 100 && finalExamPassed && !course.certificateIssued);
            });

            if (inProgressCourses.length === 0) {
                container.innerHTML = `
                    <div class="card text-center">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üöÄ</div>
                        <h3 style="margin-bottom: 1rem;">Ready to Start Learning?</h3>
                        <p style="color: #666; margin-bottom: 2rem;">
                            ${progressData.some(course => course.certificateIssued) ? 
                                'Great job on completing your courses! Explore more courses below or check your certificates.' : 
                                'Begin your enrolled courses to see them here'}
                        </p>
                        <a href="#recommendedCourses" class="btn btn-primary" onclick="document.getElementById('recommendedCourses').scrollIntoView({behavior: 'smooth'})">
                            ${progressData.some(course => course.certificateIssued) ? 'Explore More Courses' : 'View My Courses'}
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="course-grid">
                    ${inProgressCourses.slice(0, 3).map(course => {
                        const progress = course.overallProgress || 0;
                        const isCompleted = progress >= 100;
                        const finalExamTaken = course.finalExamTaken || false;
                        const finalExamPassed = course.finalExamPassed || false;
                        const canGetCertificate = isCompleted && finalExamPassed && !course.certificateIssued;
                        const needsFinalExam = isCompleted && !finalExamTaken;
                        const hasStarted = progress > 0;
                        
                        return `
                            <div class="card course-card">
                                <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='150' viewBox='0 0 400 150'><rect width='400' height='150' fill='%23667eea'/><text x='200' y='75' text-anchor='middle' dy='0.35em' fill='white' font-size='16' font-family='Arial'>üìö Learnova</text></svg>" alt="${course.courseName || 'Course'}" 
                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="margin-bottom: 0.5rem; color: #333;">${course.courseName || 'Unnamed Course'}</h4>
                                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">by ${course.instructorName || 'Unknown Instructor'}</p>
                                
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.9rem; color: #666;">Progress</span>
                                        <span style="font-size: 0.9rem; font-weight: bold; color: ${progress >= 100 ? '#28a745' : progress > 0 ? '#667eea' : '#6c757d'};">
                                            ${Math.min(progress, 100)}%
                                        </span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${Math.min(progress, 100)}%; background: ${progress >= 100 ? '#28a745' : progress > 0 ? '#667eea' : '#e1e5e9'};"></div>
                                    </div>
                                </div>
                                
                                ${needsFinalExam ? `
                                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #fff3cd; border-radius: 8px; text-align: center;">
                                        <div style="color: #856404; font-weight: bold; margin-bottom: 0.5rem;">üìù Course Complete!</div>
                                        <div style="color: #856404; font-size: 0.9rem;">Take final assessment to get certified</div>
                                    </div>
                                ` : canGetCertificate ? `
                                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #d4edda; border-radius: 8px; text-align: center;">
                                        <div style="color: #155724; font-weight: bold; margin-bottom: 0.5rem;">üéâ Assessment Passed!</div>
                                        <div style="color: #155724; font-size: 0.9rem;">Ready to claim your certificate</div>
                                    </div>
                                ` : !hasStarted ? `
                                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e2e3e5; border-radius: 8px; text-align: center;">
                                        <div style="color: #383d41; font-weight: bold; margin-bottom: 0.5rem;">üìö Ready to Start</div>
                                        <div style="color: #383d41; font-size: 0.9rem;">Begin your learning journey</div>
                                    </div>
                                ` : ''}
                                
                                <div style="display: flex; gap: 0.5rem;">
                                    ${canGetCertificate ? `
                                        <button onclick="getCertificate('${course.courseName || ''}')" class="btn btn-primary" style="flex: 1; background: #28a745; border-color: #28a745;">
                                            Get Certificate üìú
                                        </button>
                                    ` : needsFinalExam ? `
                                        <button onclick="takeFinalExam('${course.courseName || ''}')" class="btn btn-primary" style="flex: 1; background: #ffc107; border-color: #ffc107; color: #000;">
                                            Take Final Assessment üìù
                                        </button>
                                    ` : hasStarted ? `
                                        <a href="course-learn.html?course=${encodeURIComponent(course.courseName || '')}" class="btn btn-primary" style="flex: 1;">Continue</a>
                                    ` : `
                                        <a href="course-learn.html?course=${encodeURIComponent(course.courseName || '')}" class="btn btn-primary" style="flex: 1;">Start Now</a>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Load achievements
        function loadAchievements(progressData) {
            const achievements = [];
            
            // Generate achievements based on progress
            const completedCourses = progressData.filter(course => course.isCompleted);
            const certificatesEarned = progressData.filter(course => course.certificateIssued);
            
            if (completedCourses.length >= 1) {
                achievements.push('üéì First Course Completed');
            }
            if (completedCourses.length >= 5) {
                achievements.push('üèÜ Learning Enthusiast');
            }
            if (certificatesEarned.length >= 1) {
                achievements.push('üìú Certificate Earner');
            }
            if (progressData.some(course => course.finalExamScore && course.finalExamScore.percentage >= 90)) {
                achievements.push('‚≠ê High Achiever');
            }

            if (achievements.length > 0) {
                document.getElementById('achievementsSection').style.display = 'block';
                document.getElementById('achievements').innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${achievements.map(achievement => `
                            <span class="achievement-badge">${achievement}</span>
                        `).join('')}
                    </div>
                `;
            }
        }

        // Load recent activity
        function loadRecentActivity(progressData) {
            const container = document.getElementById('recentActivity');
            
            // Generate recent activities - prioritize completed courses
            const activities = [];
            
            // First, add completed courses
            progressData.forEach(course => {
                if (course.isCompleted && course.completedAt) {
                    activities.push({
                        type: 'completion',
                        message: `Completed "${course.courseName}"`,
                        date: new Date(course.completedAt),
                        icon: 'üéâ',
                        priority: 1 // High priority for completed courses
                    });
                }
            });

            // Add certificate activities
            progressData.forEach(course => {
                if (course.certificateIssued && course.certificateIssuedAt) {
                    activities.push({
                        type: 'certificate',
                        message: `Earned certificate for "${course.courseName}"`,
                        date: new Date(course.certificateIssuedAt),
                        icon: 'üìú',
                        priority: 2
                    });
                }
            });
            
            // Add quiz activities (only if we have space)
            progressData.forEach(course => {
                if (course.quizScores && course.quizScores.length > 0) {
                    const latestQuiz = course.quizScores[course.quizScores.length - 1];
                    if (latestQuiz.submittedAt) {
                        activities.push({
                            type: 'quiz',
                            message: `Scored ${latestQuiz.percentage}% on quiz in "${course.courseName}"`,
                            date: new Date(latestQuiz.submittedAt),
                            icon: latestQuiz.percentage >= 80 ? 'üåü' : 'üìù',
                            priority: 3
                        });
                    }
                }
            });

            // Add course start activities (lowest priority)
            progressData.forEach(course => {
                if (course.overallProgress > 0 && !course.isCompleted && course.enrolledAt) {
                    activities.push({
                        type: 'start',
                        message: `Started learning "${course.courseName}"`,
                        date: new Date(course.enrolledAt),
                        icon: 'üöÄ',
                        priority: 4
                    });
                }
            });

            // Sort by priority first, then by date (most recent first)
            activities.sort((a, b) => {
                if (a.priority !== b.priority) {
                    return a.priority - b.priority;
                }
                return b.date - a.date;
            });

            if (activities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                        <p>Start learning to see your activity here!</p>
                    </div>
                `;
                return;
            }

            // Show only the top 3 activities, focusing on recent completions
            const recentActivities = activities.slice(0, 3);

            container.innerHTML = `
                <div style="space-y: 1rem;">
                    ${recentActivities.map(activity => `
                        <div style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #e1e5e9;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; margin-right: 1rem; color: white;">
                                ${activity.icon}
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; color: #333;">${activity.message}</p>
                            </div>
                            <div style="color: #999; font-size: 0.9rem;">
                                ${activity.date.toLocaleDateString()}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Load recommended courses (actually student's enrolled courses)
        async function loadRecommendedCourses() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/student-progress-details', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch enrolled courses');
                }

                const enrolledCourses = await response.json();
                const container = document.getElementById('recommendedCourses');

                // Filter out deleted/unknown courses
                const validCourses = enrolledCourses.filter(course => 
                    course.courseName && 
                    course.courseName !== 'Unknown Course' && 
                    course.courseName !== 'Deleted Course' &&
                    course.courseName.trim() !== ''
                );

                if (!Array.isArray(validCourses) || validCourses.length === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                            <p style="color: #666;">You haven't enrolled in any courses yet.</p>
                            <a href="courses.html" class="btn btn-primary" style="margin-top: 1rem;">Browse Courses</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="course-grid">
                        ${validCourses.map(course => {
                            const hasStarted = course.overallProgress > 0;
                            const isCompleted = course.overallProgress >= 100;
                            const finalExamTaken = course.finalExamTaken || false;
                            const finalExamPassed = course.finalExamPassed || false;
                            const canGetCertificate = isCompleted && finalExamPassed && !course.certificateIssued;
                            const needsFinalExam = isCompleted && !finalExamTaken;
                            
                            let buttonText = 'Start Now';
                            let buttonAction = `startCourse('${course.courseName}')`;
                            let buttonStyle = '';
                            
                            if (course.certificateIssued) {
                                buttonText = 'View Certificate üìú';
                                buttonAction = `previewCertificate('${course.courseName || ''}')`;
                                buttonStyle = 'background: #28a745; border-color: #28a745;';
                            } else if (canGetCertificate) {
                                buttonText = 'Get Certificate üìú';
                                buttonAction = `getCertificate('${course.courseName || ''}')`;
                                buttonStyle = 'background: #28a745; border-color: #28a745;';
                            } else if (needsFinalExam) {
                                buttonText = 'Take Final Assessment üìù';
                                buttonAction = `takeFinalExam('${course.courseName || ''}')`;
                                buttonStyle = 'background: #ffc107; border-color: #ffc107; color: #000;';
                            } else if (hasStarted && !isCompleted) {
                                buttonText = 'Continue';
                                buttonAction = `window.location.href='course-learn.html?course=${encodeURIComponent(course.courseName || '')}'`;
                            } else if (!hasStarted) {
                                buttonAction = `window.location.href='course-learn.html?course=${encodeURIComponent(course.courseName || '')}'`;
                            }
                            
                            return `
                                <div class="card course-card">
                                    <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='150' viewBox='0 0 400 150'><rect width='400' height='150' fill='%23667eea'/><text x='200' y='75' text-anchor='middle' dy='0.35em' fill='white' font-size='16' font-family='Arial'>üìö Course Image</text></svg>" alt="${course.courseName || 'Course'}" 
                                         style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;">
                                    <h4 style="margin-bottom: 0.5rem; color: #333;">${course.courseName || 'Unnamed Course'}</h4>
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">by ${course.instructorName || 'Unknown Instructor'}</p>
                                    
                                    ${hasStarted ? `
                                        <div style="margin-bottom: 1rem;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                                <span style="font-size: 0.9rem; color: #666;">Progress</span>
                                                <span style="font-size: 0.9rem; font-weight: bold; color: ${(course.overallProgress || 0) >= 100 ? '#28a745' : '#667eea'};">
                                                    ${Math.min((course.overallProgress || 0), 100)}%
                                                </span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${Math.min((course.overallProgress || 0), 100)}%; background: ${(course.overallProgress || 0) >= 100 ? '#28a745' : '#667eea'};"></div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${canGetCertificate ? `
                                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #d4edda; border-radius: 8px; text-align: center;">
                                            <div style="color: #155724; font-weight: bold; margin-bottom: 0.5rem;">üéâ Course Completed!</div>
                                            <div style="color: #155724; font-size: 0.9rem;">Ready to claim your certificate</div>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
                                        <span>üïí ${course.estimatedHours || 'N/A'}h</span>
                                        ${course.certificateIssued ? '<span style="color: #28a745; font-weight: bold;">üèÜ Certified</span>' :
                                          canGetCertificate ? '<span style="color: #28a745; font-weight: bold;">‚úÖ Ready for Certificate</span>' :
                                          needsFinalExam ? '<span style="color: #ffc107; font-weight: bold;">ÔøΩ Final Assessment Required</span>' :
                                          isCompleted ? '<span style="color: #28a745; font-weight: bold;">‚úÖ Course Complete</span>' :
                                          hasStarted ? '<span style="color: #007bff;">üìö In Progress</span>' : 
                                          '<span style="color: #6c757d;">‚è≥ Not Started</span>'}
                                    </div>
                                    
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="${buttonAction}" class="btn btn-primary" style="flex: 1; ${buttonStyle}">${buttonText}</button>
                                        ${!hasStarted || (hasStarted && !isCompleted) ? `
                                            <button onclick="testCompleteCourse('${course.courseName || ''}')" class="btn btn-outline" style="flex: 0.7; font-size: 0.8rem;" title="Complete course instantly for testing">Test Complete</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('Error loading enrolled courses:', error);
                document.getElementById('recommendedCourses').innerHTML = `
                    <div class="card text-center">
                        <p style="color: #dc3545;">Error loading your courses.</p>
                        <button onclick="loadRecommendedCourses()" class="btn btn-primary" style="margin-top: 1rem;">Retry</button>
                    </div>
                `;
            }
        }

        // Start course function
        async function startCourse(courseName) {
            if (!courseName) {
                showAlert('Course name is missing', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                // Mark course as started
                const startResponse = await fetch(`/api/courses/${encodeURIComponent(courseName)}/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!startResponse.ok) {
                    const errorText = await startResponse.text();
                    throw new Error(`Failed to start course: ${errorText}`);
                }

                const result = await startResponse.json();
                console.log('Course started:', result);

                // Show success message
                showAlert('Course started successfully! üöÄ', 'success');
                
                // Refresh the dashboard to update the UI immediately
                await loadStudentData();
                
                // Navigate to the course learning page after a brief delay
                setTimeout(() => {
                    window.location.href = `course-learn.html?course=${encodeURIComponent(courseName)}`;
                }, 2000);
                
            } catch (error) {
                console.error('Error starting course:', error);
                showAlert(`Failed to start course: ${error.message}`, 'error');
            }
        }

        // Check server connectivity
        async function checkServerConnection() {
            try {
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    }
                });
                return response.ok;
            } catch (error) {
                console.log('Server connectivity check failed:', error);
                return false;
            }
        }

        // Helper function to handle certificate API errors
        function handleCertificateError(error, courseName) {
            console.error('Certificate error for', courseName, ':', error);
            
            if (error.status === 500) {
                if (error.message && error.message.includes('corrupted')) {
                    // Show special message for corrupted certificates with recovery option
                    showAlert('üîß Certificate data appears corrupted. Click "Get Certificate" to regenerate it automatically.', 'error');
                } else {
                    showAlert('üîß Certificate system temporarily unavailable. Please try again in a few minutes.', 'error');
                }
            } else if (error.status === 503) {
                showAlert('üîÑ Database temporarily busy. Please try again shortly.', 'error');
            } else if (error.status === 404) {
                showAlert('‚ùå Course not found or certificate not available yet. Please ensure the course is completed.', 'error');
            } else if (error.status === 400) {
                if (error.message && error.message.includes('already issued')) {
                    showAlert('‚úÖ Certificate already exists! Check your completed courses section.', 'info');
                } else if (error.debug && error.debug.progress !== undefined) {
                    showAlert(`üìà Course progress: ${error.debug.progress}%. Please complete all lessons first.`, 'error');
                } else {
                    showAlert('‚ö†Ô∏è Certificate requirements not met. Please complete the course and pass the final exam.', 'error');
                }
            } else if (error.status === 0) {
                showAlert('üåê Connection issue. Please check your internet and try again.', 'error');
            } else {
                showAlert(`‚ö†Ô∏è Certificate error: ${error.message || 'Please try again later'}`, 'error');
            }
        }

        // Preview certificate function
        async function previewCertificate(courseName) {
            if (!courseName) {
                showAlert('Course name is missing', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                // Show loading
                showAlert('Loading certificate... ‚è≥', 'info');
                
                // Try to get existing certificate first
                let response = await fetch(`/api/courses/${encodeURIComponent(courseName)}/certificate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // If no existing certificate and response is 404, it might not be ready yet
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorObj;
                    try {
                        errorObj = JSON.parse(errorText);
                    } catch (e) {
                        errorObj = { error: errorText };
                    }
                    
                    // For preview, just show error without trying to generate
                    handleCertificateError({
                        status: response.status,
                        message: errorObj.error || 'Certificate not available',
                        debug: errorObj.debug
                    }, courseName);
                    return;
                }

                // Get the HTML content
                const certificateHTML = await response.text();
                
                // Open in new window for preview
                const previewWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
                if (previewWindow) {
                    previewWindow.document.open();
                    previewWindow.document.write(certificateHTML);
                    previewWindow.document.close();
                    previewWindow.focus();
                    showAlert('Certificate opened in new window! üìú', 'success');
                } else {
                    showAlert('‚ö†Ô∏è Popup blocked! Please allow popups for this site to view certificates.', 'error');
                }
                
            } catch (error) {
                console.error('Error previewing certificate:', error);
                handleCertificateError({
                    status: 0,
                    message: error.message || 'Network or connection error'
                }, courseName);
            }
        }

        // Get certificate function
        async function getCertificate(courseName) {
            if (!courseName) {
                showAlert('Course name is missing', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                // Show loading state
                showAlert('Generating certificate... ‚è≥', 'info');
                
                // First check if certificate already exists
                let response = await fetch(`/api/courses/${encodeURIComponent(courseName)}/certificate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // If corrupted or not found, try to generate a new one
                if (!response.ok) {
                    if (response.status === 404 || response.status === 500) {
                        console.log('Certificate not found or corrupted, generating new one...');
                        response = await fetch(`/api/courses/${encodeURIComponent(courseName)}/certificate`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                    }
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorObj;
                    try {
                        errorObj = JSON.parse(errorText);
                    } catch (e) {
                        errorObj = { error: errorText || 'Unknown server error' };
                    }
                    
                    handleCertificateError({
                        status: response.status,
                        message: errorObj.error || 'Unknown error',
                        debug: errorObj.debug
                    }, courseName);
                    
                    // If it's an "already issued" error, refresh dashboard
                    if (response.status === 400 && errorObj.error && errorObj.error.includes('already issued')) {
                        setTimeout(() => loadStudentData(), 1000);
                    }
                    return;
                }

                // Get the HTML content
                const certificateHTML = await response.text();
                
                // Create a blob and download link
                const blob = new Blob([certificateHTML], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                
                // Create download link
                const link = document.createElement('a');
                link.href = url;
                link.download = `${courseName.replace(/\s+/g, '_')}_Certificate.html`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the URL object
                window.URL.revokeObjectURL(url);
                
                // Show success message
                showAlert('Certificate downloaded successfully! üéâ', 'success');
                
                // Refresh the dashboard to update the UI
                setTimeout(() => loadStudentData(), 1000);
                
            } catch (error) {
                console.error('Error generating certificate:', error);
                handleCertificateError({
                    status: 0,
                    message: error.message || 'Network or connection error'
                }, courseName);
            }
        }

        // Add takeFinalExam function
        async function takeFinalExam(courseName) {
            if (!courseName) {
                showAlert('Course name is missing', 'error');
                return;
            }
            // Navigate to course learning page where final exam is available
            window.location.href = `course-learn.html?course=${encodeURIComponent(courseName)}&finalExam=true`;
        }

        // Show course details modal
        async function showCourseModal(courseName, hasCertificate) {
            if (!courseName) {
                showAlert('Course name is missing', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                
                // Get course details from progress data
                const progressResponse = await fetch('/api/student-progress-details', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!progressResponse.ok) {
                    throw new Error('Failed to fetch course details');
                }

                const progressData = await progressResponse.json();
                const courseData = progressData.find(course => course.courseName === courseName);
                
                if (!courseData) {
                    showAlert('Course not found', 'error');
                    return;
                }

                // Update modal content
                document.getElementById('modalCourseTitle').textContent = courseData.courseName;
                
                const isCompleted = courseData.overallProgress >= 100;
                const finalExamTaken = courseData.finalExamTaken || false;
                const finalExamPassed = courseData.finalExamPassed || false;
                const canGetCertificate = isCompleted && finalExamPassed && !courseData.certificateIssued;
                const needsFinalExam = isCompleted && !finalExamTaken;

                document.getElementById('modalCourseContent').innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='200' viewBox='0 0 300 200'><rect width='300' height='200' fill='%23667eea'/><text x='150' y='100' text-anchor='middle' dy='0.35em' fill='white' font-size='16' font-family='Arial'>üìö ${courseData.courseName}</text></svg>" alt="${courseData.courseName}" 
                             style="width: 100%; max-width: 300px; height: 200px; object-fit: cover; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #333; margin-bottom: 1rem;">Course Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>Instructor:</strong><br>
                                <span style="color: #666;">${courseData.instructorName || 'Unknown'}</span>
                            </div>
                            <div>
                                <strong>Duration:</strong><br>
                                <span style="color: #666;">${courseData.estimatedHours || 'N/A'} hours</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Progress:</strong>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                <div class="progress-bar" style="flex: 1; margin-right: 1rem;">
                                    <div class="progress-fill" style="width: ${Math.min(courseData.overallProgress || 0, 100)}%; background: ${(courseData.overallProgress || 0) >= 100 ? '#28a745' : '#667eea'};"></div>
                                </div>
                                <span style="font-weight: bold; color: ${(courseData.overallProgress || 0) >= 100 ? '#28a745' : '#667eea'};">
                                    ${Math.min(courseData.overallProgress || 0, 100)}%
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Status:</strong><br>
                            <span style="color: ${courseData.certificateIssued ? '#28a745' : canGetCertificate ? '#28a745' : needsFinalExam ? '#ffc107' : '#007bff'};">
                                ${courseData.certificateIssued ? 'üèÜ Certified' :
                                  canGetCertificate ? '‚úÖ Ready for Certificate' :
                                  needsFinalExam ? 'üìù Final Assessment Required' :
                                  isCompleted ? '‚úÖ Course Complete' :
                                  (courseData.overallProgress || 0) > 0 ? 'üìö In Progress' : 
                                  '‚è≥ Not Started'}
                            </span>
                        </div>
                        
                        ${courseData.enrolledAt ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Enrolled:</strong><br>
                                <span style="color: #666;">${new Date(courseData.enrolledAt).toLocaleDateString()}</span>
                            </div>
                        ` : ''}
                        
                        ${courseData.completedAt ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Completed:</strong><br>
                                <span style="color: #666;">${new Date(courseData.completedAt).toLocaleDateString()}</span>
                            </div>
                        ` : ''}
                        
                        ${courseData.finalExamScore && courseData.finalExamScore.percentage ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Final Exam Score:</strong><br>
                                <span style="color: ${courseData.finalExamScore.percentage >= 70 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                    ${courseData.finalExamScore.percentage}%
                                </span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        ${courseData.certificateIssued ? `
                            <button onclick="previewCertificate('${courseName}')" class="btn btn-primary" style="background: #28a745; border-color: #28a745;">
                                View Certificate üìú
                            </button>
                            <button onclick="getCertificate('${courseName}')" class="btn btn-outline">
                                Download Certificate
                            </button>
                        ` : canGetCertificate ? `
                            <button onclick="getCertificate('${courseName}')" class="btn btn-primary" style="background: #28a745; border-color: #28a745;">
                                Get Certificate üìú
                            </button>
                        ` : needsFinalExam ? `
                            <button onclick="takeFinalExam('${courseName}'); closeModal();" class="btn btn-primary" style="background: #ffc107; border-color: #ffc107; color: #000;">
                                Take Final Assessment üìù
                            </button>
                        ` : ''}
                        
                        <button onclick="closeModal()" class="btn btn-outline">
                            Close
                        </button>
                    </div>
                `;

                // Show the modal
                document.getElementById('courseModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading course details:', error);
                showAlert('Failed to load course details', 'error');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('courseModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('courseModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Test function to complete a course (for development/testing)
        async function testCompleteCourse(courseName) {
            if (!courseName) {
                showAlert('Course name is missing', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                const response = await fetch(`/api/test/complete-course/${encodeURIComponent(courseName)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to complete course: ${errorText}`);
                }

                showAlert('Course marked as completed for testing! üéØ', 'success');
                await loadStudentData();
                
            } catch (error) {
                console.error('Error completing course:', error);
                showAlert(`Failed to complete course: ${error.message}`, 'error');
            }
        }

        // Defensive check for undefined variables
        // (Removed global check for currentUser to prevent unwanted redirect)

        // Handle MetaMask connection errors
        async function connectMetaMask() {
            if (typeof window.ethereum === 'undefined') {
                console.error('MetaMask is not installed.');
                showAlert('MetaMask is not installed. Please install it to continue.', 'error');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log('Connected MetaMask account:', accounts[0]);
                return accounts[0];
            } catch (error) {
                console.error('MetaMask connection failed:', error);
                showAlert('Failed to connect to MetaMask. Please try again.', 'error');
            }
        }

        // Animate number counting
        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            const duration = 1500;
            const steps = 30;
            const increment = targetNumber / steps;
            let current = 0;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= targetNumber) {
                    current = targetNumber;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current);
            }, duration / steps);
        }

        // Show alert message
        function showAlert(message, type = 'error') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type === 'success' ? 'alert-success' : type === 'info' ? 'alert-info' : 'alert-error'}`;
            alertDiv.textContent = message;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                max-width: 400px;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                background: ${type === 'success' ? '#d4edda' : type === 'info' ? '#d1ecf1' : '#f8d7da'};
                color: ${type === 'success' ? '#155724' : type === 'info' ? '#0c5460' : '#721c24'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'info' ? '#bee5eb' : '#f5c6cb'};
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after different durations based on type
            const duration = type === 'info' ? 4000 : type === 'success' ? 5000 : 6000;
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, duration);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                loadStudentData();
            }
        });
    </script>
    <script src="navbar.js"></script>
</body>
</html>

