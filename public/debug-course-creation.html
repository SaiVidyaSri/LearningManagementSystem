<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Course Creation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .btn-test {
            background: #28a745;
        }
        .btn-test:hover {
            background: #1e7e34;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="debug-form">
        <h1>🔧 Debug Course Creation</h1>
        <p>This is a simplified course creation form for debugging purposes.</p>

        <form id="debugCourseForm">
            <div class="form-group">
                <label for="courseName">Course Name *</label>
                <input type="text" id="courseName" name="courseName" required>
            </div>

            <div class="form-group">
                <label for="category">Category *</label>
                <select id="category" name="category" required>
                    <option value="">Select Category</option>
                    <option value="technology">Technology</option>
                    <option value="business">Business</option>
                    <option value="design">Design</option>
                    <option value="marketing">Marketing</option>
                    <option value="personal-development">Personal Development</option>
                    <option value="health">Health & Fitness</option>
                    <option value="music">Music</option>
                    <option value="language">Language</option>
                </select>
            </div>

            <div class="form-group">
                <label for="level">Level *</label>
                <select id="level" name="level" required>
                    <option value="">Select Level</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>

            <div class="form-group">
                <label for="shortDescription">Short Description *</label>
                <textarea id="shortDescription" name="shortDescription" rows="3" required></textarea>
            </div>

            <div class="form-group">
                <label for="description">Detailed Description *</label>
                <textarea id="description" name="description" rows="5" required></textarea>
            </div>

            <div class="form-group">
                <label for="duration">Duration (weeks) *</label>
                <input type="number" id="duration" name="duration" min="1" max="52" required>
            </div>

            <div class="form-group">
                <label for="estimatedHours">Estimated Hours *</label>
                <input type="number" id="estimatedHours" name="estimatedHours" min="1" max="500" required>
            </div>

            <div class="form-group">
                <label for="price">Price ($)</label>
                <input type="number" id="price" name="price" min="0" step="0.01" value="0">
            </div>

            <div class="form-group">
                <label for="status">Status *</label>
                <select id="status" name="status" required>
                    <option value="draft">Draft</option>
                    <option value="pending">Submit for Review</option>
                </select>
            </div>

            <button type="button" onclick="fillTestData()" class="btn-test">Fill Test Data</button>
            <button type="submit">Create Course</button>
        </form>

        <div id="result" class="result"></div>
    </div>

    <script>
        // Authentication check
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'instructor') {
            alert('Please login as an instructor first');
            window.location.href = 'login.html';
        }

        function fillTestData() {
            document.getElementById('courseName').value = 'Debug Test Course - ' + new Date().toLocaleTimeString();
            document.getElementById('category').value = 'technology';
            document.getElementById('level').value = 'beginner';
            document.getElementById('shortDescription').value = 'This is a short description for testing course creation functionality.';
            document.getElementById('description').value = 'This is a detailed description of the test course. It includes comprehensive learning materials and practical examples to help students understand the concepts thoroughly. This course is designed for debugging purposes.';
            document.getElementById('duration').value = '4';
            document.getElementById('estimatedHours').value = '20';
            document.getElementById('price').value = '0';
            document.getElementById('status').value = 'draft';
            
            showResult('Test data filled successfully!', 'success');
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Form submission
        document.getElementById('debugCourseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('🚀 Debug course creation started');
            
            const formData = new FormData(this);
            
            // Create minimal course data
            const courseData = {
                name: formData.get('courseName'),
                category: formData.get('category'),
                level: formData.get('level'),
                shortDescription: formData.get('shortDescription'),
                description: formData.get('description'),
                duration: parseInt(formData.get('duration')),
                estimatedHours: parseInt(formData.get('estimatedHours')),
                price: parseFloat(formData.get('price')) || 0,
                status: formData.get('status'),
                language: 'English',
                prerequisites: ['Basic understanding of the subject'],
                learningOutcomes: ['Understand the concepts', 'Apply the knowledge'],
                targetAudience: ['Beginners', 'Students'],
                resources: ['Course materials'],
                tags: ['debug', 'test'],
                modules: [
                    {
                        title: 'Introduction Module',
                        description: 'Basic introduction to the course',
                        estimatedDuration: 60,
                        order: 1,
                        lessons: [
                            {
                                title: 'Welcome Lesson',
                                description: 'Welcome to the course',
                                type: 'video',
                                content: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                                duration: 10,
                                order: 1,
                                isPreview: false,
                                examination: {
                                    isEnabled: false,
                                    title: '',
                                    description: '',
                                    timeLimit: 30,
                                    passingScore: 70,
                                    maxAttempts: 3,
                                    questions: []
                                },
                                resources: []
                            }
                        ],
                        materials: [],
                        assignments: []
                    }
                ],
                finalExam: {
                    isEnabled: false,
                    title: '',
                    description: '',
                    timeLimit: 60,
                    passingScore: 70,
                    maxAttempts: 3,
                    questions: []
                }
            };

            console.log('📦 Course data:', courseData);
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;

            try {
                showResult('Creating course...', 'info');
                
                console.log('📡 Making API request...');
                console.log('Token:', token ? 'Present' : 'Missing');
                
                const response = await fetch('/api/courses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(courseData)
                });

                console.log('📊 Response status:', response.status);
                console.log('📊 Response headers:', [...response.headers.entries()]);

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Success:', result);
                    showResult(`Course created successfully! ID: ${result.course._id}`, 'success');
                    
                    // Reset form
                    setTimeout(() => {
                        this.reset();
                        showResult('Form reset. You can create another course.', 'info');
                    }, 3000);
                } else {
                    const errorText = await response.text();
                    console.error('❌ Error response:', errorText);
                    
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorJson.error || 'Unknown error';
                    } catch {
                        errorMessage = errorText || 'Failed to create course';
                    }
                    
                    showResult(`Error ${response.status}: ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('💥 Network error:', error);
                showResult(`Network error: ${error.message}`, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        console.log('🎯 Debug course creation form loaded');
        console.log('User:', user);
        console.log('Token present:', !!token);
        console.log('User role:', user.role);
        console.log('Instructor status:', user.instructorStatus);
        
        // Test API connection immediately
        if (token) {
            testAPIConnection();
        }
        
        async function testAPIConnection() {
            try {
                console.log('🧪 Testing API connection...');
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                console.log('Health check response:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ API is responding:', data);
                    showResult('API connection successful!', 'success');
                } else {
                    console.error('❌ API health check failed');
                    showResult('API connection failed', 'error');
                }
            } catch (error) {
                console.error('❌ API connection error:', error);
                showResult(`API connection error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
